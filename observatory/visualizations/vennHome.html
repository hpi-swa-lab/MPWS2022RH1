<!doctype html>

<html>
<head>
	<title>Native Image Venn Diagrams</title>
    <script src="https://d3js.org/d3.v6.js"></script>
    <script src="./build/tsc.js"></script>
    <script src="./include/venn.js"></script>

    <link
            rel="icon"
            type="image/x-icon"
            href="../assets/images/snow-circles-christmas-icon_icon-icons.com_48888.ico"
    />

    <style>
            body {
                    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                    font-size: 24px;
            }
    </style>
        
</head>

<body>
        <div id="tooltip"></div>
        <div id="svg"></div></div>
        
	<script>
        Promise.all([
                d3.csv("./data/venn/HW.csv"),
                d3.csv("./data/venn/MB.csv"),
                d3.csv("./data/venn/MB4j.csv"),
        ]).then(function(files) {
                // Files to universes
                const names = ['Hello World', 'Micronaut Basic', 'Micronaut w/ log4j'];
                //const universes = [{name: names[2], packages: files[2]}, {name: names[1], packages: files[1]}];
                const universes = [{name: names[0], packages: files[0]}, {name: names[1], packages: files[1]}, {name: names[2], packages: files[2]}];

                // Universes to intersections & venn sets
                const exclusive_intersections = get_universe_intersections(universes); // THESE ARE EXCLUSIVE!!!!
                // todo: INCLUSIVE!
                const inclusive_intersections = intersections_between(universes);
                //const venn_intersections = exclusive_intersections.map(universe_to_venn_set).filter(intersection => intersection.sets.length > 1);
                //const venn_sets = universes.map(universe_to_venn_set).concat(venn_intersections);
                const venn_sets = inclusive_intersections.map(universe_to_venn_set);

                

                // Visualize Data 
                const tooltipOffSet = 30;
                const fociOffset = [10, 40];
                const transitionDuration = 400;
                const innerCircleRadius = 6;
                const width = 1280;
                const height = 720;

                const colors = ["#4e79a7","#e15759","#76b7b2","#59a14f","#edc949","#f28e2c", "#af7aa1","#ff9da7","#9c755f","#bab0ab"]; //tableau 10
                const svgContainer = d3.select("#svg")
                                     .append("svg")
                                     .attr("width", width)
                                     .attr("height", height);
                const venngroup = svgContainer.append("g").attr("id", "venngroup");
                const chart = venn.VennDiagram({
                        colorScheme: colors,
                        textFill: '#000',
                        }).width(width).height(height);
                const div = d3.select("#venngroup");
                div.datum(venn_sets).call(chart);
                

                // tooltip
                const tooltip = d3.select("#tooltip");

                // force layout
                const foci = div.selectAll("g.venn-area text.label").nodes().map(node => Object.create({}, { 
                        x: {value: node.attributes.x.value },
                        y: {value: node.attributes.y.value },
                        sets: {value: node.__data__.sets   }
                })); 
                var nodes = [];
                // change to inclusive
                exclusive_intersections.forEach((universe, index) => {
                        nodes.push(...universe.packages.map(package => Object.create({}, {
                                universe: {value: exclusiveIndexToInclusive(index)}, 
                                name: {value: package.name}
                        })));
                });

                const simulation = d3.forceSimulation()
                        .force("charge", d3.forceManyBody());

                var node = svgContainer
                            .append("g")
			    .attr("class", "nodes")
			    .selectAll("circle")
			    .data(nodes)
			    .join("g")
                            .attr("class", n => n.universe)
			    .append("circle")
			    .attr("r", innerCircleRadius)
			    .attr("fill", n => colors[n.universe])
                            .on("mouseover", (event, data) => {
                                tooltip.transition().duration(transitionDuration)
                                        .style('opacity', 0.9)
                                        .style("display", "block");
                                tooltip.html(`<text>
                                        <b>Exclusive in: ${inclusive_intersections[data.universe].name}</b></br>
                                        Name: ${data.name} </br>
                                        </text>`);
                            })
                            .on("mouseleave", (event, data) => {
                                tooltip.transition().duration(transitionDuration)
                                        .style('display', "none");
                            });


                simulation
                        .nodes(nodes)
                        .on("tick", ticked);

                function ticked() {
                        var k = this.alpha() * 1;
                        //move the nodes to their foci/cluster
                        nodes.forEach(function(n, i) {
                                n.y += (foci[n.universe].y - fociOffset[1] - n.y) * k;
                                n.x += (foci[n.universe].x - fociOffset[0] - n.x) * k;
                        });
                        //update coordinates for the circle
                        node
                                .attr("cx", function(d) { return d.x; })
                                .attr("cy", function(d) { return d.y; });
                }

                // Aesthetics 
                div.selectAll(".venn-circle path")
                        .style("fill-opacity", 0.3)
                        .style("stroke-opacity", 0.5)
                        .style("stroke-width", 3)
                        .style('stroke', function (d, i) {
                                return colors[i];
                        });

                div.selectAll(".venn-intersection path")
                        .style("fill-opacity", 0)
                        .style("fill", "#1F77B4");

                // Events
                // Mouseover
                div.selectAll("g.venn-area")
                        .on("mouseover", function(event, data) {
                                // sort all the areas relative to the current item
                                venn.sortAreas(div, data);

                                // Display a tooltip with the current size
                                tooltip.transition().duration(transitionDuration)
                                        .style('opacity', 0.9)
                                        .style("display", "block");
                                tooltip.html(
                                        `<text>
                                                <b>Universe ${data.sets}</b><br>
                                                <b>Total Packages: </b>${data.size}<br>
                                                <b>Unique Packages: </b>${setsToIntersection(data.sets).packages.length}<br>
                                                <b>Code Size: </b>${data.size}<br>
                                        </text>`
                                        );

                                div.selectAll(".nodes circle")
                                        .style("opacity", (d,i) => console.log(d));

                                const selection = d3.select(this).transition('tooltip').duration(transitionDuration);
                                selection.select("path")
                                        .style("stroke-opacity", 1)
                                        .style("fill-opacity", 0.8);
                                selection.select("text")
                                        .style("fill", "white");
                        
                        })

                        .on('mousemove', function (event) {
                                tooltip
                                        .style('left', event.pageX + tooltipOffSet + 'px')
                                        .style('top', event.pageY + 'px');
                        })

                        .on("mouseout", function(event, data) {
                                tooltip.transition().duration(transitionDuration)
                                        .style('display', "none");
                                const selection = d3.select(this).transition('tooltip').duration(transitionDuration).transition('nodes').duration(transitionDuration);
                                
                                selection.select("path")
                                        .style("stroke-opacity", 0.5)
                                        .style("fill-opacity", (d, i ) => d.sets.length > 1? 0:0.3);
                                selection.select("text")
                                        .style("fill", "#000");

                                
                                
                                });

                        function getVennIntersectionIndex(name) {
                                return inclusive_intersections.findIndex(universe => 
                                sameMembers(universe.name.split(SEPARATOR), name.split(SEPARATOR)) );
                        }

                        function exclusiveIndexToInclusive(index) {
                                let element = exclusive_intersections[index].name;
                                return getVennIntersectionIndex(element);
                        }

                        function vennIndexToIntersection(index) {
                               return setsToIntersection(venn_sets[index].sets);
                        }

                        function nameToIntersection(name) {
                                return setsToIntersection(name.split(SEPARATOR));
                        }

                        function setsToIntersection(sets) {
                                return exclusive_intersections.find(universe => sameMembers(universe.name.split(SEPARATOR), sets));
                        }
        }).catch(function(err) {
                console.log(err);
        })
	</script>


<style> 
        text {
            font-family: 'Yanone Kaffeesatz', sans-serif;
            font-size: 12pt;
            pointer-events: none;
        }

        #tooltip {
                position: absolute;
                background: rgba(255, 255, 255, 1);
                border-radius: .4em;
                border: 2px solid #000;
                padding: 1em 1em;
                transform: translate(1em, 1em);
                user-select: none;
                pointer-events: none;
                display: none;
        }


        #tooltip span {
                display: block;
        }

        g#venngroup path { 
                transition: opacity 0.4s;
        }

        g#venngroup:hover g:not(:hover) path { 
                opacity: 0.4;
                z-index: 9999;
        }

        g#venngroup:hover g:not(:hover) text { 
                opacity: 0.4;
        }

        g.nodes:hover  {
                
        }


 </style>
</body>

</html>
